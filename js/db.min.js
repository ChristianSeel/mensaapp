function initDB(){db=window.openDatabase("mensaappcache","1.0","App Cache",5242880);db.transaction(createDBTables,dbError,function(){dbCreated=!0;db.transaction(getDBversion,dbError)})}function dbError(e){DEBUG_MODE&&console.log("[DB] database error: "+e.code+" ("+e.message+")");$("#busy").fadeOut();alert("Internal Error: "+e.message)}function createDBTables(e){e.executeSql("CREATE TABLE IF NOT EXISTS Settings (key unique, val)");e.executeSql("CREATE TABLE IF NOT EXISTS Mensen (mensaid unique, name, org, country, area, postal, city, address, lastcheck, coord_lon, coord_lat, isfavorite)");e.executeSql("CREATE TABLE IF NOT EXISTS Meals (mealid unique, datestamp, mensaid, name, label, price, info, recommendations)");e.executeSql('INSERT OR IGNORE INTO Settings (key, val) VALUES ("lastupdate", 1)');e.executeSql('INSERT OR IGNORE INTO Settings (key, val) VALUES ("dbVersion", '+requiredDBVersion+")");DEBUG_MODE&&console.log("[DB] db tables are created.")}function dropDBTables(e){e.executeSql("DROP TABLE IF EXISTS Mensen");e.executeSql("DROP TABLE IF EXISTS Meals");DEBUG_MODE&&console.log("[DB] db tables droped.");e.executeSql("UPDATE Settings SET val = "+requiredDBVersion+' WHERE key = "dbVersion"')}function getDBversion(e){e.executeSql('SELECT * FROM Settings WHERE key = "dbVersion"',[],checkDBversion,dbError)}function checkDBversion(e,t){var n=t.rows.item(0).val;DEBUG_MODE&&console.log("current db version: "+n);if(n!=requiredDBVersion){DEBUG_MODE&&console.log("db version not same as required.");dbCreated=!1;db.transaction(dropDBTables,dbError,function(){initDB()})}else db.transaction(getLastUpdate,dbError)}function getLastUpdate(e){e.executeSql('SELECT * FROM Settings WHERE key = "lastupdate"',[],checkLastUpdate,dbError)}function checkLastUpdate(e,t){var n=t.rows.item(0).val,r=!1;if(n!=1){var i=new Date(n*1e3);DEBUG_MODE&&console.log("last update on: "+i.getDate()+"."+(i.getMonth()+1)+"."+i.getFullYear()+" "+i.getHours()+":"+i.getMinutes()+":"+i.getSeconds());n<getTimestamp()-2592e3&&(r=!0)}else r=!0;if(r==1){DEBUG_MODE&&console.log("full data update needed.");getMensenFromApi(function(){hideSplashscreen()})}else getMensenFromDB(function(){hideSplashscreen()})}function getMensenFromApi(e){e==null&&(e=function(){});api("getmensen",function(t){var n=t.mensen.length;if(n>0)db.transaction(function(e){for(var n in t.mensen){var r=t.mensen[n];e.executeSql("INSERT OR IGNORE INTO Mensen (mensaid) VALUES ("+r.mensaid+")");e.executeSql("UPDATE Mensen SET name=?, org=?, country=?, area=?, city=?, lastcheck=?, coord_lon=?, coord_lat=? WHERE mensaid="+r.mensaid,[r.name,r.org,r.country,r.area,r.city,r.lastcheck,r.coord.lon,r.coord.lat])}},dbError,function(){getMensenFromDB(e);DEBUG_MODE&&console.log("mensen successfull updated")});else{DEBUG_MODE&&console.log("no mensen returned by api");e()}},function(t){DEBUG_MODE&&console.log("mensen update failed");DEBUG_MODE&&console.log(t);e();if(t.error.title)var n=t.error.title+"";else var n="Fehler";if(t.error.description)var r=t.error.description+"";else var r="Es ist ein unbekannter Fehler aufgetreten.";navigator.notification.alert(r,alertDismissed,n,"OK")})}function getMensenFromDB(e){e==null&&(e=function(){});db.transaction(getMensen,dbError);setTimeout(function(){e()},350)}function getMensen(e){e.executeSql("SELECT * FROM Mensen ORDER BY org ASC",[],writeMensen,dbError)}function writeMensen(e,t){var n=t.rows.length;if(n==0){getMensenFromApi();return!0}api("getgeoip",function(e){var r=$("#mensen .content").html('<ul class="mensen"></ul>'),i=new Array;for(var s=0;s<n;s++){mensa=t.rows.item(s);var o=111.3*Math.cos((e.geoip.lat+mensa.coord_lat)/2*.01745)*(e.geoip.lon-mensa.coord_lon),u=111.3*(e.geoip.lat-mensa.coord_lat);mensa.distance=roundNumber(Math.sqrt(o*o+u*u),2);mensa["isfavorite"]==1?r.append(mensenListTpl(mensa)):i.push(mensa)}i.sort(function(e,t){return parseFloat(e.distance)-parseFloat(t.distance)});var a=i.length;for(var s=0;s<a;s++){if(s>100||i[s].distance>150&&s>25||s==a-1){r.append('\n						<div class="square" class="linkToAbc">\n							<div class="innerwrapper">\n								<h3>Alle Mensen anzeigen</h3>\n								<p>Zur alphabetischen Liste</p>\n							</div>\n						</div>\n					');refreshScroll($("#mensen"));return}r.append(mensenListTpl(i[s]))}},function(e){$("#mensen .scrollpanel").html('<ul class="mensen"></ul>');for(var r=0;r<n;r++){$("#mensen .scrollpanel ul.mensen").append(mensenListTpl(t.rows.item(r)));r==n-1&&refreshScroll($("#mensen"))}})}function mensenListTpl(e){var t="",n="";e.isfavorite==1&&(n=" isfavorite");t+='\n			<div class="square mensa" data-mensaid="'+e.mensaid+'">\n				<span class="addFavorite'+n+'"></span>\n				<div class="innerwrapper">\n					<h3>'+e.name+'</h3>\n					<p><span class="org">'+e.org+"</span><br>\n		";typeof e.distance!="undefined"&&(t+='<span class="distance">Entfernung: <span class="distance_value">'+e.distance+" km</span></span><br>");t=t.substr(0,t.length-4);t+="</p>\n				</div>\n			</div>\n			";return t}function getSingleMensa(e){db.transaction(function(t){t.executeSql("SELECT * FROM Mensen WHERE mensaid = "+e,[],function(t,n){var r=n.rows.length;if(r==0){getMealsFromApi(e);return}var i=$("#speiseplan .content").html('<div class="mealwrapper"></div>');i.prepend(mealListTpl(meal));for(var s=0;s<r;s++){meal=n.rows.item(s);i.append(mealListTpl(meal))}},dbError)},dbError)}function pullDownAction(e,t){t.parent().attr("id")=="events"?getEventsFromApi():setTimeout(function(){alert("yeah! 42!");e.refresh()},1500)}var dbCreated=!1;